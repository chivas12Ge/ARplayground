'use strict';(function(b,f){"object"===typeof exports&&"undefined"!==typeof module?f(exports,require("troika-three-text"),require("troika-3d"),require("three"),require("troika-three-utils")):"function"===typeof define&&define.amd?define(["exports","troika-three-text","troika-3d","three","troika-three-utils"],f):(b="undefined"!==typeof globalThis?globalThis:b||self,f(b.troika_3d_text={},b.troika_three_text,b.troika_3d,b.THREE,b.troika_three_utils))})(this,function(b,f,l,g,r){function m(){var c=l.createDerivedMaterial(new g.MeshBasicMaterial({transparent:!0,
opacity:.3,depthWrite:!1}),{uniforms:{rect:{value:new g.Vector4},depthAndCurveRadius:{value:new g.Vector2}},vertexDefs:"\nuniform vec4 rect;\nuniform vec2 depthAndCurveRadius;\n",vertexTransform:"\nfloat depth = depthAndCurveRadius.x;\nfloat rad = depthAndCurveRadius.y;\nposition.x = mix(rect.x, rect.z, position.x);\nposition.y = mix(rect.w, rect.y, position.y);\nposition.z = mix(-depth * 0.5, depth * 0.5, position.z);\nif (rad != 0.0) {\n  float angle = position.x / rad;\n  position.xz = vec2(sin(angle) * (rad - position.z), rad - cos(angle) * (rad - position.z));\n  // TODO fix normals: normal.xz = vec2(sin(angle), cos(angle));\n}\n"}),
a={normal:new g.Mesh((new g.BoxBufferGeometry(1,1,1)).translate(.5,.5,.5),c),curved:new g.Mesh((new g.BoxBufferGeometry(1,1,1,32)).translate(.5,.5,.5),c)};return(m=function(){return a})()}var n=new g.Vector4,t=function(c){function a(a){c.call(this,a);this.curveRadius=this.depth=0;this._color=new g.Color;this._rect=new g.Vector4}c&&(a.__proto__=c);a.prototype=Object.create(c&&c.prototype);a.prototype.constructor=a;a.prototype.afterUpdate=function(){var a=this.top,k=this.right,h=this.bottom,e=this.left,
b=this.color,d=this.depth,f=this.curveRadius;this.instancedThreeObject=m()[f?"curved":"normal"];this._color.equals(b)||this.setInstanceUniform("diffuse",this._color=new g.Color(b));this._rect.equals(n.set(e,a,k,h))||this.setInstanceUniform("rect",n.clone());!d===this._depth&&f===this._curveRadius||this.setInstanceUniform("depthAndCurveRadius",new g.Vector2(this._depth=d,this._curveRadius=f));c.prototype.afterUpdate.call(this)};a.prototype.getBoundingSphere=function(){return null};return a}(l.Instanceable3DFacade),
u=new g.Matrix4,v=new g.Plane,p=new g.Vector2,w=new g.Vector3,q=Object.freeze([-Infinity,-Infinity,Infinity,Infinity]),x=function(c){function a(a,b){var e=this;c.call(this,a);var h=a.threeObject;this.rangeColor=52479;this.clipRect=q;this.curveRadius=0;this.template={key:function(a,b){return"rect"+b},facade:t,top:function(a){return Math.min(e.clipRect[3],Math.max(e.clipRect[1],a.top))},right:function(a){return Math.min(e.clipRect[2],Math.max(e.clipRect[0],a.right))},bottom:function(a){return Math.min(e.clipRect[3],
Math.max(e.clipRect[1],a.bottom))},left:function(a){return Math.min(e.clipRect[2],Math.max(e.clipRect[0],a.left))},depth:function(a){return.25*(a.top-a.bottom)},color:function(a){return e.rangeColor},curveRadius:function(a){return e.curveRadius},visible:function(a){var b=e.clipRect;return a.right>b[0]&&a.top>b[1]&&a.left<b[2]&&a.bottom<b[3]},renderOrder:function(a){return e.renderOrder||0}};var d=function(e){var c=h.textRenderInfo;if(c){var d=h.worldPositionToTextCoords(e.intersection.point,p);if(c=
f.getCaretAtPoint(c,d.x,d.y))b(c.charIndex,c.charIndex),a.addEventListener("drag",g),a.addEventListener("dragend",k);e.preventDefault()}},g=function(a){var c=h.textRenderInfo;if(a.ray&&c){var d;(d=(d=a.intersection)&&d.object===h&&d.point?h.worldPositionToTextCoords(d.point,p):a.ray.clone().applyMatrix4(r.invertMatrix4(h.matrixWorld,u)).intersectPlane(v.setComponents(0,0,1,0),w))&&(c=f.getCaretAtPoint(c,d.x,d.y))&&b(e.selectionStart,c.charIndex);a.preventDefault()}},k=function(c){a.removeEventListener("drag",
g);a.removeEventListener("dragend",k)};a.addEventListener("dragstart",d);a.addEventListener("mousedown",d);this._cleanupEvents=function(){k();a.removeEventListener("dragstart",d);a.removeEventListener("mousedown",d)}}c&&(a.__proto__=c);a.prototype=Object.create(c&&c.prototype);a.prototype.constructor=a;var b={clipRect:{configurable:!0}};a.prototype.afterUpdate=function(){this.data=f.getSelectionRects(this.textRenderInfo,this.selectionStart,this.selectionEnd);c.prototype.afterUpdate.call(this)};b.clipRect.set=
function(a){this._clipRect=a&&Array.isArray(a)&&4===a.length?a:q};b.clipRect.get=function(){return this._clipRect};a.prototype.destructor=function(){this._cleanupEvents();c.prototype.destructor.call(this)};Object.defineProperties(a.prototype,b);return a}(l.ListFacade),y="text anchorX anchorY font fontSize letterSpacing lineHeight maxWidth overflowWrap direction textAlign textIndent whiteSpace material color colorRanges fillOpacity outlineOpacity outlineColor outlineWidth outlineOffsetX outlineOffsetY outlineBlur strokeColor strokeWidth strokeOpacity curveRadius depthOffset clipRect orientation glyphGeometryDetail sdfGlyphSize debugSDF".split(" "),
z=function(c){function a(a){var b=this,e=new f.Text;e.geometry.boundingSphere.version=0;c.call(this,a,e);this.selectable=!1;this.selectionStart=this.selectionEnd=-1;this.onSyncComplete=this.onSyncStart=null;e.addEventListener("syncstart",function(a){b.notifyWorld("text3DSyncStart");if(b.onSyncStart)b.onSyncStart()});e.addEventListener("synccomplete",function(a){if(!b.isDestroying&&(e.geometry.boundingSphere.version++,b.afterUpdate(),b.notifyWorld("text3DSyncComplete"),b.requestRender(),b.onSyncComplete))b.onSyncComplete()})}
c&&(a.__proto__=c);a.prototype=Object.create(c&&c.prototype);a.prototype.constructor=a;var b={textRenderInfo:{configurable:!0}};b.textRenderInfo.get=function(){return this.threeObject.textRenderInfo};a.prototype.afterUpdate=function(){var a=this,b=this.threeObject;y.forEach(function(c){b[c]=a[c]});b.sync();c.prototype.afterUpdate.call(this);this.text!==this._prevText&&(this.selectionStart=this.selectionEnd=-1,this._prevText=this.text);this._updateSelection()};a.prototype._updateSelection=function(){var a=
this,b=this.selectable,c=this.selectionStart,f=this.selectionEnd,d=this._selectionFacade;b!==this._selectable&&((this._selectable=b)?d=this._selectionFacade=new x(this,function(b,c){a.selectionStart=b;a.selectionEnd=c;a._updateSelection();a.requestRender()}):(d&&(d.destructor(),d=this._selectionFacade=null),this.selectionStart=this.selectionEnd=-1));d&&(d.textRenderInfo=this.threeObject.textRenderInfo,d.selectionStart=c,d.selectionEnd=f,d.curveRadius=this.curveRadius||0,d.clipRect=this.clipRect,d.renderOrder=
this.renderOrder,d.afterUpdate())};a.prototype.destructor=function(){this.threeObject.dispose();this._selectionFacade&&this._selectionFacade.destructor();c.prototype.destructor.call(this)};Object.defineProperties(a.prototype,b);return a}(l.Object3DFacade);Object.defineProperty(b,"GlyphsGeometry",{enumerable:!0,get:function(){return f.GlyphsGeometry}});Object.defineProperty(b,"TextMesh",{enumerable:!0,get:function(){return f.Text}});Object.defineProperty(b,"configureTextBuilder",{enumerable:!0,get:function(){return f.configureTextBuilder}});
Object.defineProperty(b,"dumpSDFTextures",{enumerable:!0,get:function(){return f.dumpSDFTextures}});Object.defineProperty(b,"fontProcessorWorkerModule",{enumerable:!0,get:function(){return f.fontProcessorWorkerModule}});Object.defineProperty(b,"getCaretAtPoint",{enumerable:!0,get:function(){return f.getCaretAtPoint}});Object.defineProperty(b,"getSelectionRects",{enumerable:!0,get:function(){return f.getSelectionRects}});Object.defineProperty(b,"preloadFont",{enumerable:!0,get:function(){return f.preloadFont}});
b.Text3DFacade=z;Object.defineProperty(b,"__esModule",{value:!0})})
