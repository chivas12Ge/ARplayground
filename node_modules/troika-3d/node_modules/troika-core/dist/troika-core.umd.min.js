'use strict';(function(p,A){"object"===typeof exports&&"undefined"!==typeof module?A(exports,require("troika-animation"),require("react"),require("prop-types")):"function"===typeof define&&define.amd?define(["exports","troika-animation","react","prop-types"],A):(p="undefined"!==typeof globalThis?globalThis:p||self,A(p.troika_core={},p.troika_animation,p.React,p.PropTypes))})(this,function(p,A,v,C){function P(a){return a&&"object"===typeof a&&"default"in a?a:{"default":a}}function Q(){for(var a=arguments,
c=arguments[0],d=1,b=arguments.length;d<b;d++){var e=a[d];if(e)for(var h in e)e.hasOwnProperty(h)&&(c[h]=e[h])}return c}function R(){for(var a=arguments,c=arguments[0],d=1,b=arguments.length;d<b;d++){var e=a[d];if(e)for(var h in e)e.hasOwnProperty(h)&&!c.hasOwnProperty(h)&&(c[h]=e[h])}return c}function S(a,c){if(c)for(var d in c)c.hasOwnProperty(d)&&(a[d]&&"object"===typeof a[d]&&"object"===typeof c[d]?S(a[d],c[d]):a[d]=c[d])}function G(a,c){var d=new WeakMap;return function(b){var e=d.get(b);e||
(e=c(b),d.set(b,e));return e}}function T(a){return(a=a.$$typeof)&&a.toString&&"Symbol(react.element)"===a.toString()||!1}function da(a,c){return"paused"===a?void 0:Infinity===c?"Infinity":c}function ea(a,c){return a.time-c.time}function H(a){return"onDoubleClick"===a?"dblclick":a.replace(/^on/,"").toLowerCase()}function fa(){function a(b,e,d,a){try{b.call(e,d,a)}catch(f){console.error(f)}}var c=this,d=Object.create(null);this.addListenerForFacade=function(b,e,a){e=d[e]||(d[e]={count:0,byFacadeId:Object.create(null)});
b=b.$facadeId;var c=e.byFacadeId[b];c?Array.isArray(c)?-1===c.indexOf(a)&&(e.count++,c.push(a)):c!==a&&(e.count++,e.byFacadeId[b]=[c,a]):(e.count++,e.byFacadeId[b]=a)};this.removeListenerForFacade=function(b,e,a){e=d[e];b=b.$facadeId;var c=e&&e.byFacadeId[b];c===a?(e.count--,delete e.byFacadeId[b]):Array.isArray(c)&&(a=c.indexOf(a),-1<a&&(e.count--,1===c.length?delete e.byFacadeId[b]:c.splice(a,1)))};this.removeAllListenersForFacade=function(b){b=b.$facadeId;for(var e in d){var a=d[e].byFacadeId[b];
a&&(d[e].count-=Array.isArray(a)?a.length:1,delete d[e].byFacadeId[b])}};this.hasFacadeListenersOfType=function(b,e){return d[e]?!!d[e].byFacadeId[b.$facadeId]:!1};this.hasAnyListenersOfType=function(b){return d[b]?0<d[b].count:!1};this.findBubblingEventTarget=function(b,e){for(;b;){if(c.hasFacadeListenersOfType(b,e))return b;b=b.parent}return null};this.forEachFacadeListenerOfType=function(b,e,c,g){e=d[e];b=b.$facadeId;if(e=e&&e.byFacadeId[b])if(Array.isArray(e))for(var h=0;h<e.length;h++)a(c,g,
e[h],b);else a(c,g,e,b)};this.forEachListenerOfType=function(b,e,c){if((b=d[b])&&0<b.count)for(var g in b.byFacadeId){var h=b.byFacadeId[g];if(Array.isArray(h))for(var k=0;k<h.length;k++)a(e,c,h[k],g);else a(e,c,h,g)}};this.dispatchEventOnFacade=function(b,e){function a(b){b.call(d,e)}var d=b;for(e.target=b;d&&!e.propagationStopped;)if(e.currentTarget=d,c.forEachFacadeListenerOfType(d,e.type,a,null),e.bubbles)d=d.parent;else break}}function I(a){return"touchend"===a.type||"touchcancel"===a.type}function ha(a){a.stopPropagation();
a.preventDefault()}var r=P(v);v=P(C);var D=Object.assign||Q;C=function(){var a=new WeakMap,c=0;return function(d){var b=a.get(d);b||a.set(d,b="$id"+ ++c);return b}}();C=Object.freeze({__proto__:null,assign:D,_assign:Q,assignIf:R,assignDeep:S,forOwn:function(a,c,d){for(var b in a)a.hasOwnProperty(b)&&c.call(d,a[b],b,a)},getIdForObject:C,memoize:function(a){var c,d,b;return function(){var e=arguments,h=!c||this!==d||arguments.length!==c.length;if(!h)for(var g=0,f=arguments.length;g<f;g++)if(e[g]!==
c[g]){h=!0;break}h&&(c=Array.prototype.slice.call(arguments),d=this,b=a.apply(this,arguments));return b}},createClassExtender:G,isReactElement:T});var l=function(a){this.$facadeId="facade"+ia++;this.parent=a};l.prototype.update=function(a){if(a&&"object"===typeof a){this.transition=a.transition;this.animation=a.animation;for(var c in a)a.hasOwnProperty(c)&&!l.isSpecialDescriptorProperty(c)&&(this[c]=a[c])}this.afterUpdate();this.requestRender()};l.prototype.afterUpdate=function(){var a=this.ref;a!==
this._lastRef&&("function"===typeof this._lastRef&&this._lastRef.call(null,null),"function"===typeof a?(a.call(null,this),this._lastRef=a):this._lastRef=null)};l.prototype.notifyWorld=function(a,c){if(this.parent)this.parent.onNotifyWorld(this,a,c)};l.prototype.onNotifyWorld=function(a,c,d){var b=this._notifiableParent;if(b)b.onNotifyWorld.call(b,a,c,d);else{b=this.parent;for(var e=l.prototype.onNotifyWorld;b;){if(b.onNotifyWorld!==e){this._notifiableParent=b;b.onNotifyWorld(a,c,d);break}b=b.parent}}};
l.prototype.requestRender=function(){this.notifyWorld("needsRender")};l.prototype.traverse=function(a){a(this)};l.prototype.forEachChild=function(a){};l.prototype.addEventListener=function(a,c){this.notifyWorld("addEventListener",{type:a,handler:c})};l.prototype.removeEventListener=function(a,c){this.notifyWorld("removeEventListener",{type:a,handler:c})};l.prototype.dispatchEvent=function(a){this.notifyWorld("dispatchEvent",a)};l.prototype.destructor=function(){this.parent&&this.notifyWorld("removeAllEventListeners");
"function"===typeof this.ref&&this.ref.call(null,null);this.parent=this._notifiableParent=null};D(l.prototype,{ref:null,_lastRef:null,_notifiableParent:null});var ia=0,ja={key:1,facade:1,transition:1,animation:1};l.isSpecialDescriptorProperty=function(a){return ja.hasOwnProperty(a)};l.defineEventProperty=function(a,c,d){var b=c+"\u27a4handler";Object.defineProperty(a.prototype,c,{get:function(){return this[b]},set:function(e){var a=this[b];(e||null)!==(a||null)&&("function"===typeof a&&this.removeEventListener(d,
a),"function"===typeof e&&this.addEventListener(d,e),this[b]=e)}})};var U=[null],V=G("animatable",function(a){function c(b,e){if(!d.prototype.hasOwnProperty(b)){for(var c=b+"\u27a4anim:actualValue",g=b+"\u27a4anim:actuallySet",f=b+"\u27a4anim:hasBeenSet",k=b+"\u27a4anim:tween",m,u,L=a.prototype;L;){var J=Object.getOwnPropertyDescriptor(L,b);if(J){u=J.set;m=J.get;if(u&&!m||m&&!u)throw Error("Animatable: property "+b+" has a custom "+(u?"setter":"getter")+" but no "+(u?"getter":"setter")+". Animatable properties must have both.");
break}L=Object.getPrototypeOf(L)}var n=u?function(b){u.call(this,b);this[f]||(this[f]=!0)}:function(b){this[c]=b;this[f]||(this[f]=!0)};Object.defineProperty(d.prototype,g,{value:n});Object.defineProperty(d.prototype,b,{get:function(){return m?m.call(this):this[f]?this[c]:a.prototype[b]},set:function(a){var e=this;if(!this.animation$animatingProps||!this.animation$animatingProps[b]){var c=this.animation$runner,d=this.transition;if(d&&d[b]&&this[f]&&d.hasOwnProperty(b)){d=d[b];var g="spring"===d?"default":
d.spring,h=this[k],u=!1;h?a!==h.toValue&&(g&&h.isSpring?h.toValue=a:(c.stop(h),u=!0)):a!==this[b]&&(u=!0);u&&(h=this[k]=g?new A.SpringTween(n.bind(this),this[b],a,g,0,d.delay||0):new A.Tween(n.bind(this),this[b],a,d.duration||750,d.delay||0,d.easing||"easeOutCubic",1,"forward",d.interpolate||"number"),h.onDone=function(){h=e[k]=null},c.start(h))}else n.call(this,a),(a=this[k])&&c.stop(a),this[k]=null}}})}e.hasOwnProperty(b)&&(e[b+"\u27a4anim:actualValue"]=e[b],e[b+"\u27a4anim:hasBeenSet"]=!0,delete e[b])}
var d=function(b){function a(){for(var a=this,d=[],c=arguments.length;c--;)d[c]=arguments[c];b.apply(this,d);this.animation$runner=new A.Runner;this.animation$runner.onTick=function(){a.afterUpdate();a.requestRender()}}b&&(a.__proto__=b);a.prototype=Object.create(b&&b.prototype);a.prototype.constructor=a;var d={transition:{configurable:!0},animation:{configurable:!0}};d.transition.set=function(b){if(b)for(var a in b)b.hasOwnProperty(a)&&c(a,this);this.transition$descriptor=b};d.transition.get=function(){return this.transition$descriptor};
d.animation.set=function(b){if(this.animation$descriptor!==b){this.animation$descriptor=b;var a=this.animation$tweens||null,d=this.animation$tweens=b?Object.create(null):null,e=this.animation$runner,h=!1;b&&!Array.isArray(b)&&(U[0]=b,b=U);if(b)for(var g=0,J=b.length;g<J;g++){var n=b[g];if(n){var t=JSON.stringify(n,da);if(a&&t in a){var q=a[t];n.paused?e.pause(q):e.start(q);d[t]=q}else{h=0;var l=750,p="linear",r=1;q=[];var v="forward",w;for(w in n)if(n.hasOwnProperty(w))switch(w){case "duration":l=
n[w];break;case "delay":h=n[w];break;case "easing":p=n[w];break;case "iterations":r=n[w];break;case "direction":v=n[w];break;default:var z="from"===w?0:"to"===w?100:parseFloat(w);if(!isNaN(z)&&0<=z&&100>=z){q.push({time:z/100,props:n[w]});for(var x in n[w])n[w].hasOwnProperty(x)&&(c(x,this),z=x+"\u27a4anim:tween",this[z]&&(e.stop(this[z]),this[z]=null))}}if(q.length){q.sort(ea);0<q[0].time&&q.unshift(R({time:0},q[0]));z=[];for(var y=1,D=q.length;y<D;y++){var C=q[y],B=C.props,E;for(E in B)if(B.hasOwnProperty(E)){for(var F=
null,G=y;G--;)if(E in q[G].props){F=q[G];break}F&&(F=new A.Tween(this[E+"\u27a4anim:actuallySet"].bind(this),F.props[E],B[E],(C.time-F.time)*l,F.time*l,"linear",1,"forward",n.interpolate&&n.interpolate[E]||"number"),F.$$property=E,z.push(F))}}t=d[t]=new A.MultiTween(z,l,h,p,r,v);n.paused||e.start(t);if(0===h){n=q[0].props;for(var H in n)if(n.hasOwnProperty(H))this[H+"\u27a4anim:actuallySet"](n[H])}}h=!0}}}if(a)for(var K in a)d&&d[K]||(b=a[K],b.gotoEnd(),e.stop(b),h=!0);if(h)if(d){a=this.animation$animatingProps=
Object.create(null);for(var I in d)for(e=d[I].tweens,K=e.length;K--;)a[e[K].$$property]=!0}else this.animation$animatingProps=null}};d.animation.get=function(){return this.animation$descriptor};a.prototype.destructor=function(){var a=this,d=this.animation$runner;if(this.exitAnimation&&!this.parent.isDestroying){d.stopAll();this.animation=this.exitAnimation;this.exitAnimation=this.transition=null;var c=d.onTick;d.onTick=function(){a.parent&&!a.parent.isDestroying?c():(d.onDone=null,a.destructor())};
d.onDone=function(){a.requestRender();a.destructor()}}else d.destructor(),b.prototype.destructor.call(this)};Object.defineProperties(a.prototype,d);return a}(a);return d}),W=G("pointerStates",function(a){function c(b,d){var c=b+"\u27a4pntr:hasBeenSet";d[c]||(d[b+"\u27a4pntr:baseValue"]=d[b],delete d[b],d[c]=!0);if(!m.prototype.hasOwnProperty(b)){k[b]=1;var e=b+"\u27a4pntr:baseValue",h=b+"\u27a4pntr:appliedValue";Object.defineProperty(m.prototype,b,{get:function(){a:{var d=a.prototype;if(b in d)for(;d;){var c=
Object.getOwnPropertyDescriptor(d,b);if(c&&c.get){d=c.get;break a}d=Object.getPrototypeOf(d)}d=null}return d?d.call(this):h in this?this[h]:this[e]},set:function(b){this[e]=b}})}}function d(b,d,c){a:{var e=a.prototype;if(d in e)for(;e;){var h=Object.getOwnPropertyDescriptor(e,d);if(h&&h.set){e=h.set;break a}e=Object.getPrototypeOf(e)}e=null}e?e.call(b,c):b[d+"\u27a4pntr:appliedValue"]=c}function b(b){b.currentTarget["\u27a4pntr:isHovering"]=!0;f(b)}function e(b){b.currentTarget["\u27a4pntr:isHovering"]=
b.currentTarget["\u27a4pntr:isActive"]=!1;f(b)}function h(b){b.currentTarget["\u27a4pntr:isActive"]=!0;f(b)}function g(b){b.currentTarget["\u27a4pntr:isActive"]=!1;f(b)}function f(b){b=b.currentTarget;for(var d=b.parent;d&&d.shouldUpdateChildren();)d.isPointerStateAware&&(b=d),d=d.parent;b.afterUpdate();b.requestRender()}var k=Object.create(null),m=function(a){function f(d){a.call(this,d);this.addEventListener("mouseover",b);this.addEventListener("mouseout",e);this.addEventListener("mousedown",h);
this.addEventListener("mouseup",g)}a&&(f.__proto__=a);f.prototype=Object.create(a&&a.prototype);f.prototype.constructor=f;f.prototype.afterUpdate=function(){this._applyPointerStates();a.prototype.afterUpdate.call(this)};f.prototype._applyPointerStates=function(){var b=this.pointerStates,a=b&&this["\u27a4pntr:isHovering"]&&b.hover||null,e=b&&this["\u27a4pntr:isActive"]&&b.active||null;b=this["\u27a4pntr:lastAppliedValues"]||k;if(a=this["\u27a4pntr:lastAppliedValues"]=a||e?D(Object.create(null),a,e):
null)for(var h in a)c(h,this),d(this,h,a[h]);if(b)for(var g in b)a&&g in a||d(this,g,this[g+"\u27a4pntr:baseValue"])};return f}(a);Object.defineProperty(m.prototype,"isPointerStateAware",{value:!0});return m}),ka=function(a){function c(d){a.call(this,d);this._orderedItemKeys=[]}a&&(c.__proto__=a);c.prototype=Object.create(a&&a.prototype);c.prototype.constructor=c;c.prototype.afterUpdate=function(){var d=this.data,b=this.template,e=d&&d.length&&Array.isArray(d);if("production"!==process.env.NODE_ENV){if(d&&
!Array.isArray(d))throw Error('ListFacade "data" must be an array.');if(!b||"object"!==typeof b)throw Error('ListFacade "template" must be an object.');if(!b||"function"!==typeof b.key)throw Error('ListFacade template must define a "key" function.');if(!b||"function"!==typeof b.facade)throw Error('ListFacade template must define a "facade".');}if(this.shouldUpdateChildren()){var c=this._itemsDict||null,g=this._itemsDict=e?Object.create(null):null,f=this._orderedItemKeys;if(e){f.length=d.length;e=
0;for(var k=d.length;e<k;e++){var m=d[e],u=b.key(m,e,d),l=b.facade;if("production"!==process.env.NODE_ENV){if(null==u)throw Error('ListFacade template "key" function must return a key.');g[u]&&console.warn("Duplicate key in list: "+u)}for(;g[u];)u+="|dupe";var p="function"===typeof b.transition?b.transition(m,e,d):b.transition,n="function"===typeof b.animation?b.animation(m,e,d):b.animation,t="function"===typeof b.exitAnimation?b.exitAnimation(m,e,d):b.exitAnimation;if(p||n||t)l=V(l);t=b.pointerStates;
if("function"===t?t(m,e,d):t)l=W(l);(t=c&&c[u])&&t.constructor===l?l=t:(t&&t.destructor(),l=new l(this));l.transition=p;l.animation=n;for(var q in b)b.hasOwnProperty(q)&&!a.isSpecialDescriptorProperty(q)&&(l[q]="function"===typeof b[q]?b[q](m,e,d):b[q]);l.afterUpdate();g[u]=l;f[e]=u}}if(c)for(var r in c)g&&g[r]||c[r].destructor()}a.prototype.afterUpdate.call(this)};c.prototype.shouldUpdateChildren=function(){return!0};c.prototype.traverse=function(a,b){a.call(b,this);for(var d=this._orderedItemKeys,
c=this._itemsDict,g=0,f=d.length;g<f;g++)c[d[g]].traverse(a,b)};c.prototype.forEachChild=function(a,b){for(var d=this._orderedItemKeys,c=this._itemsDict,g=0,f=d.length;g<f;g++)a.call(b,c[d[g]],d[g])};c.prototype.destructor=function(){this.isDestroying=!0;var d=this._itemsDict;if(d)for(var b in d)d[b].destructor();a.prototype.destructor.call(this)};return c}(l),X=[null],M=function(a){function c(d){a.call(this,d);this.children=null;this._orderedChildKeys=[]}a&&(c.__proto__=a);c.prototype=Object.create(a&&
a.prototype);c.prototype.constructor=c;c.prototype.afterUpdate=function(){this.shouldUpdateChildren()&&this.updateChildren(this.describeChildren());a.prototype.afterUpdate.call(this)};c.prototype.describeChildren=function(){return this.children};c.prototype.shouldUpdateChildren=function(){return!0};c.prototype.updateChildren=function(d){var b=this._childrenDict||null,c=this._childrenDict=null,h=this._orderedChildKeys;h.length=0;if(d){Array.isArray(d)||(X[0]=d,d=X);for(var g=0,f=d.length;g<f;g++){var k=
d[g];if(k){c||(c=this._childrenDict=Object.create(null));var m=T(k),l=m?k.props:k;m=m?k.type:k.facade;k=k.key;if(!k){var p=0;do k="auto:"+m.name+":"+p++;while(c[k])}if("production"!==process.env.NODE_ENV&&"function"!==typeof m)throw Error('All scene objects must have a "facade" property pointing to a class/constructor');if(c[k])for(console.warn("Duplicate key in children: "+k);c[k];)k+="|dupe";p=l.transition;var r=l.animation;if(p||r||l.exitAnimation)m=V(m);l.pointerStates&&(m=W(m));var n=b&&b[k];
n&&n.constructor===m?m=n:(n&&n.destructor(),m=new m(this));m.transition=p;m.animation=r;for(var t in l)l.hasOwnProperty(t)&&!a.isSpecialDescriptorProperty(t)&&(m[t]=l[t]);c[k]=m;h.push(k);m.afterUpdate()}}}if(b)for(var q in b)c&&c[q]||b[q].destructor()};c.prototype.getChildByKey=function(a){var b=this._childrenDict;return b&&b[a]||null};c.prototype.traverse=function(a,b){a.call(b,this);for(var d=this._orderedChildKeys,c=this._childrenDict,g=0,f=d.length;g<f;g++)c[d[g]].traverse(a,b)};c.prototype.forEachChild=
function(a,b){for(var d=this._orderedChildKeys,c=this._childrenDict,g=0,f=d.length;g<f;g++)a.call(b,c[d[g]],d[g])};c.prototype.destructor=function(){this.isDestroying=!0;var d=this._childrenDict;if(d)for(var b in d)d[b].destructor();a.prototype.destructor.call(this)};return c}(l),x="onMouseOver onMouseOut onMouseMove onDragStart onDrag onDragEnter onDragOver onDragLeave".split(" "),B="onMouseDown onMouseUp onClick onDoubleClick onDrop onDragEnd onWheel".split(" "),Y=B.map(H),Z=x.map(H);x=x.concat(B);
var aa=Z.concat(Y),N=function(a){function c(){a.apply(this,arguments)}a&&(c.__proto__=a);c.prototype=Object.create(a&&a.prototype);c.prototype.constructor=c;c.prototype.interceptsPointerEvents=function(a){if(!1===this.pointerEvents)return!1;if(this.pointerEvents)return!0;for(var b=0,d=aa.length;b<d;b++)if(a.hasFacadeListenersOfType(this,aa[b]))return!0};return c}(M);Object.defineProperty(N.prototype,"isPointerEventTarget",{value:!0});x.forEach(function(a){l.defineEventProperty(N,a,H(a))});var la=
{},ma=["mousemove","mouseout","touchmove"],na="mousedown mouseup click dblclick wheel touchstart touchend touchcancel".split(" "),ba=["mouseup","touchend","touchcancel"],oa={touchstart:"mousedown",touchend:"mouseup",touchcancel:"mouseup"},pa="clientX clientY screenX screenY pageX pageY".split(" "),y=function(a,c,d,b,e){var h=this,g;for(g in a)"function"!==typeof a[g]&&(this[g]=a[g]);this.target=d;this.relatedTarget=b;this.type=c;this.nativeEvent=a;D(this,e);if(a.touches){var f=I(a)?a.changedTouches:
a.touches;1===f.length&&pa.forEach(function(b){h[b]=f[0][b]})}};y.prototype.preventDefault=function(){this.defaultPrevented=!0;this.nativeEvent.preventDefault()};y.prototype.stopPropagation=function(){this.propagationStopped=!0;this.nativeEvent.stopPropagation()};x=function(a){function c(b){a.call(this,null);this.width=this.height=1;this._element=b;this._htmlOverlays=Object.create(null);this.eventRegistry=new fa;this._onPointerMotionEvent=this._onPointerMotionEvent.bind(this);this._onPointerActionEvent=
this._onPointerActionEvent.bind(this);this._onDropEvent=this._onDropEvent.bind(this);this._togglePointerListeners(!0)}a&&(c.__proto__=a);c.prototype=Object.create(a&&a.prototype);c.prototype.constructor=c;var d={renderingScheduler:{configurable:!0}};c.prototype.afterUpdate=function(){this._queueRender();a.prototype.afterUpdate.call(this)};c.prototype.onNotifyWorld=function(b,a,d){(a=this._notifyWorldHandlers[a])&&a.call(this,b,d)};c.prototype._isContinuousRender=function(){return this.continuousRender};
d.renderingScheduler.set=function(b){b=b||window;if(b!==this.renderingScheduler){var a=this._nextFrameTimer;a&&(this.renderingScheduler.cancelAnimationFrame(a),this._nextFrameTimer=null);this._renderingScheduler=b}};d.renderingScheduler.get=function(){return this._renderingScheduler||window};c.prototype._queueRender=function(){var b=this;if(!this._nextFrameTimer){var a=this._nextFrameHandler||(this._nextFrameHandler=function(){for(var a=[],d=arguments.length;d--;)a[d]=arguments[d];d=b.onStatsUpdate;
var c=b.onBeforeRender,e=b.onAfterRender,l=d&&Date.now();c&&c(b);b.doRender.apply(b,a);d&&(a=Date.now(),d({"Render CPU Time (ms)":a-l,"Time Between Frames (ms)":b._lastFrameTime?a-b._lastFrameTime:"?",FPS:b._lastFrameTime?Math.round(1E3/(a-b._lastFrameTime)):"?"}),b._lastFrameTime=a);b._doRenderHtmlItems();e&&e(b);b._nextFrameTimer=null;b._isContinuousRender()&&b._queueRender()});this._nextFrameTimer=this.renderingScheduler.requestAnimationFrame(a)}};c.prototype.doRender=function(){};c.prototype.getFacadeUserSpaceXYZ=
function(b){};c.prototype._doRenderHtmlItems=function(){if(this.renderHtmlItems){var b=[],a=this._htmlOverlays,d;for(d in a){var c=a[d],f=this.getFacadeUserSpaceXYZ(c);0<=f.z&&(f.key=c.$facadeId,f.html=c.html,f.exact=c.exact,b.push(f))}this.renderHtmlItems(b)}};c.prototype._normalizePointerEvent=function(b){};c.prototype._onPointerMotionEvent=function(b){this._normalizePointerEvent(b);var a=this._getPointerEventState(b);if(Z.some(this.eventRegistry.hasAnyListenersOfType)){var d="mouseout"===b.type||
I(b)?null:this._findHoverTarget(b),c=a.hoveredFacade,f=a.hoveredFacade=d&&d.facade,k=a.dragInfo;k&&(k.dragStartFired||(this._firePointerEvent("dragstart",k.dragStartEvent,k.draggedFacade,null,d),k.dragStartFired=!0),this._firePointerEvent("drag",b,k.draggedFacade,null,d));f!==c&&(c&&(this._firePointerEvent("mouseout",b,c,f,d),k&&this._firePointerEvent("dragleave",b,c,f,d)),f&&(this._firePointerEvent("mouseover",b,f,c,d),k&&this._firePointerEvent("dragenter",b,f,c,d)));f&&(this._firePointerEvent("mousemove",
b,f,null,d),k&&this._firePointerEvent("dragover",b,f,null,d))}(d=a.tapInfo)&&"touchmove"===b.type&&(b=b.changedTouches[0])&&10<Math.sqrt(Math.pow(b.clientX-d.x,2)+Math.pow(b.clientY-d.y,2))&&(a.tapInfo=null)};c.prototype._onPointerActionEvent=function(b){this._normalizePointerEvent(b);-1<ba.indexOf(b.type)&&this._onDropEvent(b);"touchstart"===b.type&&(1===b.touches.length&&this._onPointerMotionEvent(b),this._enableContextMenu(!1));var a=this.eventRegistry;if(a.hasAnyListenersOfType("dragstart")||
Y.some(a.hasAnyListenersOfType)){var d=this._findHoverTarget(b),c=d&&d.facade;if(c){var f=this._getPointerEventState(b);this._firePointerEvent(oa[b.type]||b.type,b,c,null,d);if(a.findBubblingEventTarget(c,"click")||a.findBubblingEventTarget(c,"dblclick")){var k=f.tapInfo;"touchstart"===b.type&&1===b.touches.length?f.tapInfo={facade:c,x:b.touches[0].clientX,y:b.touches[0].clientY,startTime:Date.now(),isDblClick:k&&300>Date.now()-k.startTime}:k&&k.facade===c&&"touchend"===b.type&&0===b.touches.length&&
1===b.changedTouches.length&&300>Date.now()-k.startTime&&(this._firePointerEvent("click",b,c,null,d),k.isDblClick&&this._firePointerEvent("dblclick",b,c,null,d))}if("mousedown"===b.type||"touchstart"===b.type)if(a=a.findBubblingEventTarget(c,"dragstart"))d=new y(b,"dragstart",a,null,{intersection:d}),f.dragInfo={draggedFacade:a,dragStartFired:!1,dragStartEvent:d},this._toggleDropListeners(!0)}b.preventDefault()}I(b)&&(1===b.changedTouches.length&&this._onPointerMotionEvent(b),this._enableContextMenu(!0))};
c.prototype._onDropEvent=function(b){var a=this._getPointerEventState(b),d=a.dragInfo;if(d){this._normalizePointerEvent(b);var c=this._findHoverTarget(b),f=c&&c.facade;f&&this._firePointerEvent("drop",b,f,null,c);this._firePointerEvent("dragend",b,d.draggedFacade,null,c);this._toggleDropListeners(!1);a.dragInfo=null}};c.prototype._firePointerEvent=function(b,a,d,c,f){b=a instanceof y?a:new y(a,b,d,c,{bubbles:!0,intersection:f});this.eventRegistry.dispatchEventOnFacade(d,b)};c.prototype._getPointerEventState=
function(b){var a=this._pointerEventStates||(this._pointerEventStates=new WeakMap);b=b.eventSource||la;var d=a.get(b);d||a.set(b,d={});return d};c.prototype._toggleDropListeners=function(b){var a=this;ba.forEach(function(d){document[(b?"add":"remove")+"EventListener"](d,a._onDropEvent,!0)})};c.prototype._togglePointerListeners=function(b){var a=this,d=this._element;if(d&&b!==this._pointerListenersAttached){var c=(b?"add":"remove")+"EventListener";ma.forEach(function(b){d[c](b,a._onPointerMotionEvent,
!1)});na.forEach(function(b){d[c](b,a._onPointerActionEvent,!1)});this._pointerListenersAttached=b}};c.prototype._enableContextMenu=function(b){var a=this._element;if(a)a[(b?"remove":"add")+"EventListener"]("contextmenu",ha,!0)};c.prototype.getFacadesAtEvent=function(b,a){throw Error("getFacadesAtEvent: no impl");};c.prototype._findHoverTarget=function(b){var a=this;if(b.touches&&1<b.touches.length)return null;if(b=this.getFacadesAtEvent(b,function(b){return b.isPointerEventTarget&&b.interceptsPointerEvents(a.eventRegistry)})){for(var d=
b[0],c=1;c<b.length;c++)if(b[c].distance<d.distance||b[c].distance===d.distance&&(b[c].distanceBias||0)<(d.distanceBias||0))d=b[c];return d}return null};c.prototype.destructor=function(){this._nextFrameTimer&&this.renderingScheduler.cancelAnimationFrame(this._nextFrameTimer);this._togglePointerListeners(!1);this._toggleDropListeners(!1);a.prototype.destructor.call(this)};Object.defineProperties(c.prototype,d);return c}(M);Object.defineProperty(x.prototype,"isWorld",{value:!0});x.prototype._notifyWorldHandlers=
{needsRender:function(){this._queueRender()},addEventListener:function(a,c){this.eventRegistry.addListenerForFacade(a,c.type,c.handler)},removeEventListener:function(a,c){this.eventRegistry.removeListenerForFacade(a,c.type,c.handler)},removeAllEventListeners:function(a){this.eventRegistry.removeAllListenersForFacade(a)},dispatchEvent:function(a,c){c instanceof y||(c=new y(c,c.type,c.target,c.relatedTarget));this.eventRegistry.dispatchEventOnFacade(a,c)},addHtmlOverlay:function(a){this._htmlOverlays[a.$facadeId]=
a},removeHtmlOverlay:function(a){delete this._htmlOverlays[a.$facadeId]},statsUpdate:function(a,c){(a=this.onStatsUpdate)&&a(c)}};var qa={position:"absolute",top:0,right:0,bottom:0,left:0,pointerEvents:"none",transformStyle:"preserve-3d"},O=function(a){function c(){a.apply(this,arguments)}a&&(c.__proto__=a);c.prototype=Object.create(a&&a.prototype);c.prototype.constructor=c;c.prototype.shouldComponentUpdate=function(a){return a.html!==this.props.html||!0===(a.html.props&&a.html.props.shouldUpdateOnMove)};
c.prototype.render=function(){var a=this.props.html;return"string"===typeof a?r["default"].createElement("span",null,a):r["default"].cloneElement(a)};return c}(r["default"].Component);O.displayName="Canvas3D.HtmlOverlayContent";O.propTypes={html:v["default"].node};var ca=function(a){function c(d){a.call(this,d);this.setItems=this.setItems.bind(this);this.state={items:null}}a&&(c.__proto__=a);c.prototype=Object.create(a&&a.prototype);c.prototype.constructor=c;c.prototype.shouldComponentUpdate=function(a,
b){a=this.state;return b.items&&b.items.length||a.items&&a.items.length};c.prototype.setItems=function(a){var b=this.state.items;(a&&a.length||b&&b.length)&&this.setState({items:a||null})};c.prototype.render=function(){var a=this.state.items,b=Math.round;return a&&a.length?r["default"].createElement("div",{className:"troika_html_overlay",style:qa},a.map(function(a){var d=a.key,c=a.html,e=a.x,k=a.y,l=a.z;a.exact||(e=b(e),k=b(k));return r["default"].createElement("div",{key:d,style:{position:"absolute",
transform:"translate3d("+e+"px, "+k+"px, "+-l+"px)"}},r["default"].createElement(O,{html:c}))})):null};return c}(r["default"].Component);ca.displayName="Canvas3D.HtmlOverlay";var ra={position:"absolute",top:0,right:0,background:"rgba(0,0,0,.5)",font:"11px sans-serif",padding:10},sa=function(a){function c(d){a.call(this,d);this.state={stats:{}}}a&&(c.__proto__=a);c.prototype=Object.create(a&&a.prototype);c.prototype.constructor=c;c.prototype.setStats=function(a){this.setState({stats:a})};c.prototype.render=
function(){var a=this.state.stats;return r["default"].createElement("div",{style:ra},Object.keys(a).sort().map(function(b){return r["default"].createElement("div",{key:b},b+": "+a[b])}))};return c}(r["default"].Component),ta={width:"100%",height:"100%"};B=function(a){function c(d){a.call(this,d);this._stats={};this.updateStats=this.updateStats.bind(this);this.renderHtmlItems=this.renderHtmlItems.bind(this);this._bindHtmlOverlayRef=this._bindHtmlOverlayRef.bind(this);this._bindCanvasRef=this._bindCanvasRef.bind(this);
this._bindStatsRef=this._bindStatsRef.bind(this)}a&&(c.__proto__=a);c.prototype=Object.create(a&&a.prototype);c.prototype.constructor=c;c.prototype.componentDidUpdate=function(){this.updateWorld()};c.prototype.initWorld=function(a){a=new this.props.worldFacade(a);a.renderHtmlItems=this.renderHtmlItems;return a};c.prototype.updateWorld=function(){var a=this._world;if(a){var b=this.props,c=b.stats,h=c&&Date.now();a.width=b.width;a.height=b.height;a.pixelRatio=b.pixelRatio;a.continuousRender=b.continuousRender;
a.onStatsUpdate=c?this.updateStats:null;D(a,b.worldProps);a.afterUpdate();c&&this.updateStats({"Last World Update (ms)":Date.now()-h})}};c.prototype.destroyWorld=function(){this._world&&(this._world.destructor(),delete this._world);clearTimeout(this._statsDelay)};c.prototype.renderHtmlItems=function(a){this._htmlOverlayRef&&this._htmlOverlayRef.setItems(a)};c.prototype.updateStats=function(a){var b=this;this._stats=D({},this._stats,a);this._statsDelay||(this._statsDelay=setTimeout(function(){b._statsDelay=
null;var a=b._statsRef;a&&a.setStats(b._stats)},250))};c.prototype._bindHtmlOverlayRef=function(a){this._htmlOverlayRef=a};c.prototype._bindCanvasRef=function(a){if(a)try{this._world=this.initWorld(a),this.updateWorld()}catch(e){console.warn("Troika."+this.constructor.displayName+": world init failed, using fallback content.",e),this._failedWorldInit=!0,this._world=null,this.forceUpdate()}else this.destroyWorld();var b=this.props.onCanvasRef;b&&b(a)};c.prototype._bindStatsRef=function(a){this._statsRef=
a};c.prototype.render=function(){var a=this.props;return r["default"].createElement("div",{className:"troika "+(a.className||""),style:{position:"relative",overflow:"hidden",width:a.width,height:a.height,cursor:a.cursor,userSelect:"none"}},this._failedWorldInit?this.props.children:r["default"].createElement("canvas",{className:"troika_canvas",ref:this._bindCanvasRef,style:a.canvasStyle||ta}),r["default"].createElement(ca,{ref:this._bindHtmlOverlayRef}),a.stats?r["default"].createElement(sa,{ref:this._bindStatsRef}):
null)};return c}(r["default"].Component);B.commonPropTypes={width:v["default"].number.isRequired,height:v["default"].number.isRequired,pixelRatio:v["default"].number,worldFacade:v["default"].func,worldProps:v["default"].object,canvasStyle:v["default"].object,className:v["default"].string,continuousRender:v["default"].bool,onCanvasRef:v["default"].func,stats:v["default"].bool,cursor:v["default"].string};p.Facade=l;p.ListFacade=ka;p.ParentFacade=M;p.PointerEventTarget=N;p.ReactCanvasBase=B;p.WorldBaseFacade=
x;p.utils=C;Object.defineProperty(p,"__esModule",{value:!0})})
